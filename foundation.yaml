AWSTemplateFormatVersion: '2010-09-09'
Description: 'Foundation Infrastructure for Agentic workloads'

Parameters:
  ProjectName:
    Type: String
    Default: agentic-web-foundation
    Description: Lowercase project identifier used in resource names and tags
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: ProjectName must be lowercase letters, numbers, and dashes only

  Stage:
    Type: String
    Default: staging
    Description: Deployment stage
    AllowedValues: [staging, prod]

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: VPC CIDR block

  EmptyDeploymentBucketOnDelete:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: In staging, empty the deployment bucket before deletion (ignored in prod)

Mappings:
  StageToConfig:
    prod:
      PrefixSuffix: ''
    staging:
      PrefixSuffix: '-staging'

Conditions:
  IsProd: !Equals [!Ref Stage, prod]
  IsStaging: !Equals [!Ref Stage, staging]
  ShouldEmptyDeploymentBucketCondition: !And [!Condition IsStaging, !Equals [!Ref EmptyDeploymentBucketOnDelete, 'true']]

Resources:
  # -----------------------------
  # Deployment bucket (staging vs prod)
  # -----------------------------
  DeploymentBucketProd:
    Condition: IsProd
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub
        - '${ProjectName}${PrefixSuffix}-deployment-${AWS::AccountId}-${AWS::Region}'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: AbortIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
          - Id: ExpireNoncurrentVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage
        - Key: Service
          Value: agentic-foundation

  DeploymentBucketStaging:
    Condition: IsStaging
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub
        - '${ProjectName}${PrefixSuffix}-deployment-${AWS::AccountId}-${AWS::Region}'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: AbortIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
          - Id: ExpireNoncurrentVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage
        - Key: Service
          Value: agentic-foundation

  # Custom resource to empty S3 bucket on stack deletion (staging only)
  EmptyBucketOnDelete:
    Condition: ShouldEmptyDeploymentBucketCondition
    Type: Custom::EmptyBucket
    Properties:
      ServiceToken: !GetAtt EmptyBucketFunction.Arn
      BucketName: !Ref DeploymentBucketStaging

  # Lambda function to empty S3 bucket (staging only)
  EmptyBucketFunction:
    Condition: ShouldEmptyDeploymentBucketCondition
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub
        - '${ProjectName}${PrefixSuffix}-empty-bucket'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt EmptyBucketRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import json
          import urllib.request
          import traceback
          
          def _send(event, context, status, data=None, physical_resource_id=None, reason=None):
              response_url = event["ResponseURL"]
              response_body = {
                  "Status": status,
                  "Reason": reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'n/a')}",
                  "PhysicalResourceId": physical_resource_id or getattr(context, "log_stream_name", "empty-bucket"),
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
                  "NoEcho": False,
                  "Data": data or {},
              }
              body = json.dumps(response_body).encode("utf-8")
              req = urllib.request.Request(
                  response_url,
                  data=body,
                  headers={"content-type": "", "content-length": str(len(body))},
                  method="PUT",
              )
              with urllib.request.urlopen(req) as _:
                  pass
          
          def lambda_handler(event, context):
              s3 = boto3.client("s3")
              bucket_name = event.get("ResourceProperties", {}).get("BucketName")
              try:
                  if not bucket_name:
                      raise ValueError("Missing ResourceProperties.BucketName")
          
                  if event.get("RequestType") == "Delete":
                      print(f"Emptying bucket before deletion: {bucket_name}")
                      paginator = s3.get_paginator("list_object_versions")
                      pages = paginator.paginate(Bucket=bucket_name)
          
                      delete_keys = []
                      for page in pages:
                          for version in page.get("Versions", []):
                              delete_keys.append({"Key": version["Key"], "VersionId": version["VersionId"]})
                          for marker in page.get("DeleteMarkers", []):
                              delete_keys.append({"Key": marker["Key"], "VersionId": marker["VersionId"]})
          
                      for i in range(0, len(delete_keys), 1000):
                          batch = delete_keys[i : i + 1000]
                          if batch:
                              s3.delete_objects(Bucket=bucket_name, Delete={"Objects": batch})
          
                      print(f"Emptied bucket: {bucket_name}")
          
                  _send(event, context, "SUCCESS", {})
              except Exception as e:
                  traceback.print_exc()
                  _send(event, context, "FAILED", {}, reason=str(e))

  # IAM Role for EmptyBucket Lambda (staging only)
  EmptyBucketRole:
    Condition: ShouldEmptyDeploymentBucketCondition
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub
        - '${ProjectName}${PrefixSuffix}-empty-bucket-role'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3EmptyBucketPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !GetAtt DeploymentBucketStaging.Arn
                  - !Sub '${DeploymentBucketStaging.Arn}/*'

  # -----------------------------
  # VPC + networking
  # -----------------------------
  FoundationVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-vpc'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-igw'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref FoundationVpc
      InternetGatewayId: !Ref InternetGateway

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-public-rt'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-public-subnet-1'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-public-subnet-2'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  Subnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref RouteTable

  Subnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref RouteTable

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-private-subnet-1'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-private-subnet-2'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-private-rt'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # VPC Endpoint for S3 (Gateway endpoint - no hourly cost)
  S3VpcEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref FoundationVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-s3-vpce'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  # -----------------------------
  # NAT Gateway (only supported NAT option)
  # -----------------------------
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-natgw-eip'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-natgw'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  PrivateRouteToNatGateway:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # -----------------------------
  # Valkey (ElastiCache Serverless)
  # -----------------------------
  ValkeySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Valkey serverless cache
      VpcId: !Ref FoundationVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          CidrIp: !Ref VpcCidr
          Description: Allow Redis/Valkey access from within the VPC only
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-valkey-sg'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage

  ValkeyPassword:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub
        - '${ProjectName}${PrefixSuffix}-valkey-password'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      Description: Password for Valkey serverless cache
      GenerateSecretString:
        SecretStringTemplate: '{"username": "default"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage
        - Key: Service
          Value: agentic-foundation

  ValkeyUser:
    Type: AWS::ElastiCache::User
    Properties:
      UserId: !Sub
        - '${ProjectName}${PrefixSuffix}-user'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      Engine: valkey
      UserName: default
      Passwords:
        - !Sub '{{resolve:secretsmanager:${ValkeyPassword}:SecretString:password}}'
      AccessString: on ~* +@all

  ValkeyUserGroup:
    Type: AWS::ElastiCache::UserGroup
    Properties:
      UserGroupId: !Sub
        - '${ProjectName}${PrefixSuffix}-users'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      Engine: valkey
      UserIds:
        - !Ref ValkeyUser

  ValkeyCacheServerless:
    Type: AWS::ElastiCache::ServerlessCache
    Properties:
      ServerlessCacheName: !Sub
        - '${ProjectName}${PrefixSuffix}-valkey'
        - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
      Engine: valkey
      UserGroupId: !Ref ValkeyUserGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref ValkeySecurityGroup
      Description: Serverless Valkey cache for agentic foundation
      Tags:
        - Key: Name
          Value: !Sub
            - '${ProjectName}${PrefixSuffix}-valkey'
            - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]
        - Key: Project
          Value: !Ref ProjectName
        - Key: Stage
          Value: !Ref Stage
        - Key: Service
          Value: agentic-foundation

Outputs:
  ProjectName:
    Description: Project name
    Value: !Ref ProjectName

  Stage:
    Description: Deployment stage
    Value: !Ref Stage

  ProjectPrefix:
    Description: Project prefix (ProjectName in prod, ProjectName-Stage otherwise)
    Value: !Sub
      - '${ProjectName}${PrefixSuffix}'
      - PrefixSuffix: !FindInMap [StageToConfig, !Ref Stage, PrefixSuffix]

  DeploymentBucketName:
    Description: S3 bucket for deployment artifacts
    Value: !If [IsProd, !Ref DeploymentBucketProd, !Ref DeploymentBucketStaging]
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentBucketName'

  DeploymentBucketArn:
    Description: S3 bucket ARN for deployment artifacts
    Value: !If [IsProd, !GetAtt DeploymentBucketProd.Arn, !GetAtt DeploymentBucketStaging.Arn]
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentBucketArn'

  ValkeyCacheEndpoint:
    Description: Valkey Serverless Cache Endpoint
    Value: !GetAtt ValkeyCacheServerless.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyCacheEndpoint'

  ValkeyCachePort:
    Description: Valkey Serverless Cache Port
    Value: !GetAtt ValkeyCacheServerless.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyCachePort'

  ValkeySecurityGroupId:
    Description: Valkey Security Group ID
    Value: !Ref ValkeySecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ValkeySecurityGroupId'

  ValkeyPasswordSecretArn:
    Description: Valkey Password Secret ARN
    Value: !Ref ValkeyPassword
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyPasswordSecretArn'

  ValkeyUserGroupId:
    Description: Valkey User Group ID
    Value: !Ref ValkeyUserGroup
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyUserGroupId'

  FoundationVpcId:
    Description: Foundation VPC ID
    Value: !Ref FoundationVpc
    Export:
      Name: !Sub '${AWS::StackName}-FoundationVpc'

  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1'

  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2'

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1'

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2'

  NatGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NatGateway
    Export:
      Name: !Sub '${AWS::StackName}-NatGatewayId'