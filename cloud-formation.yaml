AWSTemplateFormatVersion: '2010-09-09'
Description: 'Foundation Infrastructure for Agentic workloads'

Parameters:
  StackName:
    Type: String
    Default: agentic-web-foundation
    Description: Lowercase stack identifier used in resource names and tags
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: StackName must be lowercase letters, numbers, and dashes only

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: VPC CIDR block

  NatGatewayMode:
    Type: String
    Default: single
    AllowedValues:
      - single
      - multi
    Description: Use a single NAT Gateway (cheaper) or one NAT Gateway per AZ (more resilient, less cross-AZ egress)

  DeploymentBucketRemovalPolicy:
    Type: String
    Default: delete
    AllowedValues:
      - retain
      - delete
    Description: Retain keeps the deployment bucket on stack deletion; delete empties and deletes it (destructive)

  EmptyBucketLogRetentionDays:
    Type: Number
    Default: 14
    MinValue: 1
    MaxValue: 3653
    Description: CloudWatch Logs retention for the empty-bucket custom resource Lambda (only used when DeploymentBucketRemovalPolicy=delete)

Conditions:
  UseMultiNat: !Equals [!Ref NatGatewayMode, multi]
  UseSingleNat: !Equals [!Ref NatGatewayMode, single]
  RetainDeploymentBucket: !Equals [!Ref DeploymentBucketRemovalPolicy, retain]
  DeleteDeploymentBucket: !Equals [!Ref DeploymentBucketRemovalPolicy, delete]

Resources:

  DeploymentBucketRetain:
    Type: AWS::S3::Bucket
    Condition: RetainDeploymentBucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      # Bucket names must be globally unique. CloudFormation doesn't have a random()
      # intrinsic, so we derive a stable unique suffix from this stack's ID.
      BucketName: !Sub
        - '${StackName}-${Suffix}-deploy'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: AbortIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
          - Id: ExpireNoncurrentVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: StackName
          Value: !Ref StackName

  DeploymentBucketDelete:
    Type: AWS::S3::Bucket
    Condition: DeleteDeploymentBucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      # Bucket names must be globally unique. CloudFormation doesn't have a random()
      # intrinsic, so we derive a stable unique suffix from this stack's ID.
      BucketName: !Sub
        - '${StackName}-${Suffix}-deploy'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: AbortIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
          - Id: ExpireNoncurrentVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: StackName
          Value: !Ref StackName

  DeploymentBucketPolicyRetain:
    Type: AWS::S3::BucketPolicy
    Condition: RetainDeploymentBucket
    Properties:
      Bucket: !Ref DeploymentBucketRetain
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt DeploymentBucketRetain.Arn
              - !Sub '${DeploymentBucketRetain.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: false

  DeploymentBucketPolicyDelete:
    Type: AWS::S3::BucketPolicy
    Condition: DeleteDeploymentBucket
    Properties:
      Bucket: !Ref DeploymentBucketDelete
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt DeploymentBucketDelete.Arn
              - !Sub '${DeploymentBucketDelete.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: false


  # Custom resource to empty S3 bucket on stack deletion
  EmptyBucketOnDelete:
    Type: Custom::EmptyBucket
    Condition: DeleteDeploymentBucket
    Properties:
      ServiceToken: !GetAtt EmptyBucketFunction.Arn
      BucketName: !Ref DeploymentBucketDelete

  # Lambda function to empty S3 bucket
  EmptyBucketFunction:
    Type: AWS::Lambda::Function
    Condition: DeleteDeploymentBucket
    Properties:
      FunctionName: !Sub
        - '${StackName}-${Suffix}-empty-bucket'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt EmptyBucketRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import json
          import urllib.request
          import traceback
          
          def _send(event, context, status, data=None, physical_resource_id=None, reason=None):
              response_url = event["ResponseURL"]
              response_body = {
                  "Status": status,
                  "Reason": reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'n/a')}",
                  "PhysicalResourceId": physical_resource_id or getattr(context, "log_stream_name", "empty-bucket"),
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
                  "NoEcho": False,
                  "Data": data or {},
              }
              body = json.dumps(response_body).encode("utf-8")
              req = urllib.request.Request(
                  response_url,
                  data=body,
                  headers={"content-type": "", "content-length": str(len(body))},
                  method="PUT",
              )
              with urllib.request.urlopen(req) as _:
                  pass
          
          def lambda_handler(event, context):
              s3 = boto3.client("s3")
              bucket_name = event.get("ResourceProperties", {}).get("BucketName")
              try:
                  if not bucket_name:
                      raise ValueError("Missing ResourceProperties.BucketName")
          
                  if event.get("RequestType") == "Delete":
                      print(f"Emptying bucket before deletion: {bucket_name}")
                      paginator = s3.get_paginator("list_object_versions")
                      pages = paginator.paginate(Bucket=bucket_name)
          
                      delete_keys = []
                      for page in pages:
                          for version in page.get("Versions", []):
                              delete_keys.append({"Key": version["Key"], "VersionId": version["VersionId"]})
                          for marker in page.get("DeleteMarkers", []):
                              delete_keys.append({"Key": marker["Key"], "VersionId": marker["VersionId"]})
          
                      for i in range(0, len(delete_keys), 1000):
                          batch = delete_keys[i : i + 1000]
                          if batch:
                              s3.delete_objects(Bucket=bucket_name, Delete={"Objects": batch})
          
                      print(f"Emptied bucket: {bucket_name}")
          
                  _send(event, context, "SUCCESS", {})
              except Exception as e:
                  traceback.print_exc()
                  _send(event, context, "FAILED", {}, reason=str(e))

  EmptyBucketFunctionPermission:
    Type: AWS::Lambda::Permission
    Condition: DeleteDeploymentBucket
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref EmptyBucketFunction
      Principal: cloudformation.amazonaws.com

  EmptyBucketLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: DeleteDeploymentBucket
    Properties:
      LogGroupName: !Sub
        - '/aws/lambda/${StackName}-${Suffix}-empty-bucket'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      RetentionInDays: !Ref EmptyBucketLogRetentionDays

  # IAM Role for EmptyBucket Lambda
  EmptyBucketRole:
    Type: AWS::IAM::Role
    Condition: DeleteDeploymentBucket
    Properties:
      RoleName: !Sub
        - '${StackName}-${Suffix}-empty-bucket-role'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3EmptyBucketPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !GetAtt DeploymentBucketDelete.Arn
                  - !Sub '${DeploymentBucketDelete.Arn}/*'

  # -----------------------------
  # VPC + networking
  # -----------------------------
  FoundationVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-vpc'
        - Key: StackName
          Value: !Ref StackName

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-igw'
        - Key: StackName
          Value: !Ref StackName


  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref FoundationVpc
      InternetGatewayId: !Ref InternetGateway

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-public-rt'
        - Key: StackName
          Value: !Ref StackName

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-public-subnet-1'
        - Key: StackName
          Value: !Ref StackName

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-public-subnet-2'
        - Key: StackName
          Value: !Ref StackName


  Subnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref RouteTable

  Subnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref RouteTable

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-private-subnet-1'
        - Key: StackName
          Value: !Ref StackName


  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref FoundationVpc
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-private-subnet-2'
        - Key: StackName
          Value: !Ref StackName


  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-private-rt'
        - Key: StackName
          Value: !Ref StackName


  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  # VPC Endpoint for S3 (Gateway endpoint - no hourly cost)
  S3VpcEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref FoundationVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable
        - !If [UseMultiNat, !Ref PrivateRouteTable2, !Ref AWS::NoValue]
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-s3-vpce'
        - Key: StackName
          Value: !Ref StackName


  # -----------------------------
  # NAT Gateway 
  # -----------------------------
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-natgw-eip'
        - Key: StackName
          Value: !Ref StackName

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-natgw'
        - Key: StackName
          Value: !Ref StackName

  NatGatewayEIP2:
    Type: AWS::EC2::EIP
    Condition: UseMultiNat
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-natgw2-eip'
        - Key: StackName
          Value: !Ref StackName

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Condition: UseMultiNat
    Properties:
      AllocationId: !GetAtt NatGatewayEIP2.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-natgw2'
        - Key: StackName
          Value: !Ref StackName


  PrivateRouteToNatGateway:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Condition: UseMultiNat
    Properties:
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-private-rt-2'
        - Key: StackName
          Value: !Ref StackName

  PrivateSubnet2RouteTableAssociationSingle:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseSingleNat
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociationMulti:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseMultiNat
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  PrivateRouteToNatGateway2:
    Type: AWS::EC2::Route
    Condition: UseMultiNat
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  # -----------------------------
  # Valkey (ElastiCache Serverless)
  # Admin - manages valkey
  # Client - connects to valkey for user data caching
  # -----------------------------
  ValkeyClientSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Attach to services that need to connect to Valkey
      VpcId: !Ref FoundationVpc
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-valkey-client-sg'
        - Key: StackName
          Value: !Ref StackName

  ValkeySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Valkey serverless cache
      VpcId: !Ref FoundationVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref ValkeyClientSecurityGroup
          Description: Allow Redis/Valkey access only from services SG
      Tags:
        - Key: Name
          Value: !Sub '${StackName}-valkey-sg'
        - Key: StackName
          Value: !Ref StackName


  ValkeyAdminPassword:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub
        - '${StackName}-${Suffix}-valkey-admin-password'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Description: Password for Valkey serverless cache
      GenerateSecretString:
        SecretStringTemplate: '{"username": "default"}'
        GenerateStringKey: password
        PasswordLength: 32
        # Exclude: double-quote, @, /, and backslash
        ExcludeCharacters: "\"@/\\"
      Tags:
        - Key: StackName
          Value: !Ref StackName

  ValkeyClientPassword:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub
        - '${StackName}-${Suffix}-valkey-client-password'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Description: Password for Valkey client user
      GenerateSecretString:
        SecretStringTemplate: '{"username": "service"}'
        GenerateStringKey: password
        PasswordLength: 32
        # Exclude: double-quote, @, /, and backslash
        ExcludeCharacters: "\"@/\\"
      Tags:
        - Key: StackName
          Value: !Ref StackName

  ValkeyAdminUser:
    Type: AWS::ElastiCache::User
    Properties:
      UserId: !Sub
        - 'valkey-admin-user-${Suffix}'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Engine: valkey
      UserName: default
      Passwords:
        - !Sub '{{resolve:secretsmanager:${ValkeyAdminPassword}:SecretString:password}}'
      AccessString: on ~* +@all

  ValkeyClientUser:
    Type: AWS::ElastiCache::User
    Properties:
      UserId: !Sub
        - 'valkey-client-user-${Suffix}'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Engine: valkey
      UserName: service
      Passwords:
        - !Sub '{{resolve:secretsmanager:${ValkeyClientPassword}:SecretString:password}}'
      # Non-admin: allow typical data ops, deny admin/dangerous command categories.
      # (Services should still use key prefixes for isolation.)
      AccessString: on ~* +@all -@admin -@dangerous

  ValkeyUserGroup:
    Type: AWS::ElastiCache::UserGroup
    Properties:
      UserGroupId: !Sub
        - 'valkey-users-${Suffix}'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Engine: valkey
      UserIds:
        - !Ref ValkeyAdminUser
        - !Ref ValkeyClientUser

  ValkeyCacheServerless:
    Type: AWS::ElastiCache::ServerlessCache
    Properties:
      ServerlessCacheName: !Sub
        - '${StackName}-${Suffix}-valkey'
        - Suffix: !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref AWS::StackId
      Engine: valkey
      CacheUsageLimits:
        DataStorage:
          Maximum: 1
          Unit: GB
      UserGroupId: !Ref ValkeyUserGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref ValkeySecurityGroup
      Description: Serverless Valkey cache for agentic foundation
      Tags:
        - Key: StackName
          Value: !Ref StackName

Outputs:
  StackName:
    Description: Stack name (also used for resource naming)
    Value: !Ref StackName

  #===== SharedDeployment Bucket =====
  DeploymentBucketName:
    Description: S3 bucket for deployment artifacts
    Value: !If [DeleteDeploymentBucket, !Ref DeploymentBucketDelete, !Ref DeploymentBucketRetain]
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentBucketName'

  DeploymentBucketArn:
    Description: S3 bucket ARN for deployment artifacts
    Value: !If [DeleteDeploymentBucket, !GetAtt DeploymentBucketDelete.Arn, !GetAtt DeploymentBucketRetain.Arn]
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentBucketArn'

  #===== Valkey/Redis =====
  ValkeyEndpoint:
    Description: Valkey Serverless Cache Endpoint
    Value: !GetAtt ValkeyCacheServerless.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyCacheEndpoint'

  ValkeyPort:
    Description: Valkey Serverless Cache Port
    Value: !GetAtt ValkeyCacheServerless.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyCachePort'

  ValkeySecurityGroupId:
    Description: Valkey Security Group ID
    Value: !Ref ValkeySecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ValkeySecurityGroupId'

  ValkeyClientSecurityGroupId:
    Description: Security Group ID to attach to services that need Valkey access
    Value: !Ref ValkeyClientSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyClientSecurityGroupId'

  ValkeyAdminPasswordSecretArn:
    Description: Valkey admin password Secret ARN
    Value: !Ref ValkeyAdminPassword
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyAdminPasswordSecretArn'

  ValkeyClientPasswordSecretArn:
    Description: Valkey service-user password Secret ARN
    Value: !Ref ValkeyClientPassword
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyClientPasswordSecretArn'

  ValkeyClientUserName:
    Description: Valkey non-admin username for services
    Value: service
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyClientUserName'

  ValkeyUserGroupId:
    Description: Valkey User Group ID
    Value: !Ref ValkeyUserGroup
    Export:
      Name: !Sub '${AWS::StackName}-ValkeyUserGroupId'

  #===== Network =====
  FoundationVpcId:
    Description: Foundation VPC ID
    Value: !Ref FoundationVpc
    Export:
      Name: !Sub '${AWS::StackName}-FoundationVpc'

  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1'

  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2'

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1'

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2'

  NatGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NatGateway
    Export:
      Name: !Sub '${AWS::StackName}-NatGatewayId'

  NatGateway2Id:
    Condition: UseMultiNat
    Description: NAT Gateway 2 ID (only when NatGatewayMode=multi)
    Value: !Ref NatGateway2
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway2Id'